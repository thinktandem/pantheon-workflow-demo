<?php

/**
 * @file
 * Pantheon ApacheSolr module.
 *
 * We need this to locate our Class
 */

function pantheon_apachesolr_update_schema($schema) {
  $ch = curl_init();
  $host = 'index.'. variable_get('pantheon_tier', 'live') .'.getpantheon.com';
  $path = 'sites/self/environments/'. variable_get('pantheon_environment', 'dev') .'/index';
  $port = 449;
  // Figure out env var
  $client_cert = '../certs/binding.pem';
  $url = 'https://'. $host .'/'. $path;

  $file = fopen($schema, 'r');

  // set URL and other appropriate options
  $opts = array(
    CURLOPT_URL => $url,
    CURLOPT_PORT => $port,
    CURLOPT_RETURNTRANSFER => 1,
    CURLOPT_SSLCERT => $client_cert,
    CURLOPT_HTTPHEADER => array('Content-type:text/xml; charset=utf-8'),
    CURLOPT_PUT => TRUE,
    CURLOPT_BINARYTRANSFER => 1,
    CURLOPT_INFILE => $file,
    CURLOPT_INFILESIZE => filesize($schema),
  );
  curl_setopt_array($ch, $opts);

  $response = curl_exec($ch);
  if ($response == NULL) {
    watchdog('pantheon_apachesolr', "Error !error posting !schema to !url", array('!error' => curl_error($ch), '!schema' => $schema, '!url' => $url), WATCHDOG_ERROR);
  }
  fclose($file);
  return $response;
}

/**
 * Implementation of hook_form_FORM_ID_alter()
 *
 * Hides unnecessary settings from apachesolr.admin.inc.
 */
function pantheon_apachesolr_form_apachesolr_settings_alter(&$form, &$form_state, $form_id) {
  $form['apachesolr_host_settings'] = array(
    '#type' => 'item',
    '#title' => t('Solr Environment Settings'),
    '#markup' => '<p>'. t('No need to configure environments: Pantheon is managing your Solr settings.') .'</p>',
  );

  $schemas = file_scan_directory('sites/all/modules', '/schema.*\.xml/');
  $form['schemas'] = array(
    '#type' => 'item',
    '#title' => t('Solr Schema Files'),
    '#markup' => '<p>'. t('Pantheon found the following Solr schema files in your installation. You will need to choose one to get started.') .'</p>',
    '#weight' => -10,
  );
  foreach($schemas as $file => $data) {
    // Let the user pick a schema?
  }
}
